---
output: html_document
runtime: shiny
editor_options: 
  chunk_output_type: console
---
```{r}
#| include: FALSE
knitr::opts_chunk$set(echo = TRUE) 
library(tidyverse)
library(stringr)
library(rvest)
library(httr)
library(shiny)
```

```{r}

url <- "https://www.espn.com/wnba/team/roster/_/name/chi/chicago-sky"
robotstxt::paths_allowed(url)  

namechi <- read_html(url) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agechi <- read_html(url) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightchi <- read_html(url) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()


urlatl <- "https://www.espn.com/wnba/team/roster/_/name/atl/atlanta-dream"
robotstxt::paths_allowed(urlatl)  
nameatl <- read_html(urlatl) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
ageatl <- read_html(urlatl) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightatl <- read_html(urlatl) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()


urlconn <- "https://www.espn.com/wnba/team/roster/_/name/conn/connecticut-sun"
robotstxt::paths_allowed(urlconn)  
nameconn <- read_html(urlconn) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
ageconn <- read_html(urlconn) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightconn <- read_html(urlconn) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()


urldal <- "https://www.espn.com/wnba/team/roster/_/name/dal/dallas-wings"
robotstxt::paths_allowed(urldal)  
namedal <- read_html(urldal) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agedal <- read_html(urldal) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightdal <- read_html(urldal) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlind <- "https://www.espn.com/wnba/team/roster/_/name/ind/indiana-fever"
robotstxt::paths_allowed(urlind)  
nameind <- read_html(urlind) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
ageind <- read_html(urlind) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightind <- read_html(urlind) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urllv <- "https://www.espn.com/wnba/team/roster/_/name/lv/las-vegas-aces"
robotstxt::paths_allowed(urllv)  
namelv <- read_html(urllv) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agelv <- read_html(urllv) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightlv <- read_html(urllv) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlla <- "https://www.espn.com/wnba/team/roster/_/name/la/los-angeles-sparks"
robotstxt::paths_allowed(urlla)  
namela <- read_html(urlla) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agela <- read_html(urlla) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightla <- read_html(urlla) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlmin <- "https://www.espn.com/wnba/team/roster/_/name/min/minnesota-lynx"
robotstxt::paths_allowed(urlmin)  
namemin <- read_html(urlmin) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agemin <- read_html(urlmin) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightmin <- read_html(urlmin) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlny <- "https://www.espn.com/wnba/team/roster/_/name/ny/new-york-liberty"
robotstxt::paths_allowed(urlny)  
nameny <- read_html(urlny) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
ageny <- read_html(urlny) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightny <- read_html(urlny) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlphx <- "https://www.espn.com/wnba/team/roster/_/name/phx/phoenix-mercury"
robotstxt::paths_allowed(urlphx)  
namephx <- read_html(urlphx) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agephx <- read_html(urlphx) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightphx <- read_html(urlphx) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlsea <- "https://www.espn.com/wnba/team/roster/_/name/sea/seattle-storm"
robotstxt::paths_allowed(urlsea)  
namesea <- read_html(urlsea) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agesea <- read_html(urlsea) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightsea <- read_html(urlsea) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()

urlwsh <- "https://www.espn.com/wnba/team/roster/_/name/wsh/washington-mystics"
robotstxt::paths_allowed(urlwsh)  
namewsh <- read_html(urlwsh) |>
  html_nodes(".inline .AnchorLink") |>
  html_text()
agewsh <- read_html(urlwsh) |>
  html_nodes(".Table__TD:nth-child(3) .inline") |>
  html_text()
heightwsh <- read_html(urlwsh) |>
  html_nodes(".Table__TD:nth-child(4) .inline") |>
  html_text()
nameconn <- append(nameconn, "Tiffany Hayes")
ageconn <- append(ageconn, 33)
heightconn <- append(heightconn, "5' 10\"")
playerfull <- c(nameatl,namechi,nameconn,namedal,nameind,namelv,namela,namemin,nameny,namephx, namesea,namewsh)
agefull <- c(ageatl,agechi,ageconn,agedal,ageind,agelv,agela,agemin,ageny,agephx, agesea,agewsh)
heightfull <-c(heightatl,heightchi,heightconn,heightdal,heightind,heightlv,heightla,heightmin,heightny,heightphx, heightsea,heightwsh) 
```


```{r}
scrape_teamdata <- function(year){
  urlteam <-str_c("https://www.espn.com/wnba/standings/_/season/",year, sep = "")

robotstxt::paths_allowed(urlteam)  

teamm <- read_html(urlteam) |>
  html_nodes(".hide-mobile .AnchorLink") |>
  html_text()

wins <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(1) .stat-cell") |>
  html_text()
wins

losses <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(2) .stat-cell") |>
  html_text()

percent_won <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(3) .stat-cell") |>
  html_text()

home_record <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(5) .stat-cell") |>
  html_text()

away_record <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(6) .stat-cell") |>
  html_text()

conf_record <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(7) .stat-cell") |>
  html_text()

points_per_game <- read_html(urlteam) |>
  html_nodes(".Table__TD:nth-child(8) .stat-cell") |>
  html_text()

tibble(teamm, wins, losses, percent_won, home_record, away_record, conf_record, points_per_game) |>
  mutate(wins=as.double(wins), losses= as.double(losses), points_per_game= as.double(points_per_game), percent_won= as.double(percent_won)) |>
  mutate(year = year, team= teamm) |>
  select(-teamm)
}


scrape_teamdata(2023)


teamstatdata <- bind_rows(scrape_teamdata(2016),
          scrape_teamdata(2017),
          scrape_teamdata(2018), 
          scrape_teamdata(2019), 
          scrape_teamdata(2020), 
          scrape_teamdata(2021), 
          scrape_teamdata(2022), 
          scrape_teamdata(2023))

teamstatdata |>
  count(year) 


scrape_playerdata <- function(year){
  urlplayer <-str_c("https://www.espn.com/wnba/stats/player/_/season/",year,"/seasontype/2", sep = "")

robotstxt::paths_allowed(urlplayer)  

playeryear <- read_html(urlplayer) |>
  html_nodes(".mr7 .AnchorLink") |>
  html_text() 

pointsyear <- read_html(urlplayer) |>
  html_nodes(".Table__TD:nth-child(4)") |>
  html_text()

games_playedyear <- read_html(urlplayer) |>
  html_nodes(".Table__Scroller .Table__TD:nth-child(2)") |>
  html_text() 

rankyear <- read_html(urlplayer) |>
  html_nodes(".Table--fixed-left .Table__TH:nth-child(1) div , .Table--fixed-left .Table__TD:nth-child(1)") |>
  html_text() |>
  tail(n=50)

positionyear <- read_html(urlplayer) |>
  html_nodes(".position") |>
  html_text()|>
  head(n=50)

teamyear <- read_html(urlplayer) |>
  html_nodes(".athleteCell__teamAbbrev") |>
  html_text()|>
  head(n=50)

primary_data <- tibble(playeryear, pointsyear, games_playedyear, rankyear, positionyear, teamyear)

dataage <- tibble(playerfull,agefull,heightfull) |>
  mutate(agefull=(as.double(agefull)-(2024-year)))

left_join(primary_data, dataage, 
                           by = join_by(playeryear== playerfull)) |>
  mutate(heightfull= str_replace(heightfull, '"', "")) |>
  mutate(heightfull= str_replace(heightfull, "'", "")) |>
  separate(heightfull, c("feet", "inches"), " ") |>
  mutate(feet= as.double(feet), inches= as.double(inches)) |>
  mutate(feet_in_inches= feet*12, inches_in_feet= inches/12) |>
  mutate(height_in = feet_in_inches+inches, 
         height_ft= feet+inches_in_feet) |>
  select(-feet, -inches, -feet_in_inches, -inches_in_feet) |>
  mutate(year=year)
}


scrape_playerdata(2023)


playerstatdata <- bind_rows(
          scrape_playerdata(2018), 
          scrape_playerdata(2019), 
          scrape_playerdata(2020), 
          scrape_playerdata(2021), 
          scrape_playerdata(2022), 
          scrape_playerdata(2023))

playerstatdata |>
  count(year) 
```
